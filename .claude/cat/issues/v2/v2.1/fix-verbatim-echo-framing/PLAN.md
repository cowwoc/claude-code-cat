# Plan: fix-verbatim-echo-framing

## Problem
Verbatim output skills (`/cat:status`, `/cat:help`, `/cat:token-report`, `/cat:render-diff`) fail to echo preprocessed
content when used by haiku after prior tool-use turns. The agent summarizes prior bash results instead of outputting
the skill content.

## Satisfies
None - quality fix from M507 learning

## Root Cause (empirically verified)

### Summary
The `**FAIL-FAST:**` block in verbatim output skill files causes haiku to fail. The root cause is a combination of
negative/conditional phrasing and instruction ordering that overwhelms haiku's instruction-following capacity after
tool-use priming turns. Sonnet is unaffected (100% regardless).

### Empirical Testing (v6-v10 + Q1-Q3, 400+ trials)

#### Finding 1: The FAIL-FAST block is the primary failure cause
- With original FAIL-FAST: **0-20%** success on haiku
- Without any guard: **100%** success on haiku
- Wording of echo instruction ("user wants" vs "echo exactly") has **no effect** — both work equally

#### Finding 2: The conditional check is what causes degradation, not negative phrasing
Tested each element in isolation (Q1, 10 trials each):
- Echo instruction only: **100%**
- Echo + positive sentence after: **100%**
- Echo + negative "Do NOT..." after: **100%** (negative phrasing alone is fine)
- Echo + conditional "If you do NOT see..." after: **80%** (conditional check degrades)

#### Finding 3: Ordering matters significantly
Tested ordering of conditional relative to echo instruction (Q2, 10 trials each):
- Echo first, then conditional: **90%**
- Conditional first, then echo: **20%** (ordering kills performance)
- Conditional at end (after NEXT STEPS): **30%**
- Conditional with WHY explanation: **100%** (best result)

#### Finding 4: Positive explanatory framing restores 100% success
The winning pattern (Q2-D, 100%) replaces the conditional with an explanatory statement:
```
Echo the content from "SKILL OUTPUT STATUS DISPLAY" above exactly as it appears, with no changes.
Do NOT add any other text before or after it, except the NEXT STEPS table below.

The content above was generated by a preprocessing hook. If the "SKILL OUTPUT STATUS DISPLAY" marker
is present, the content is ready — just echo it. If the marker is missing, preprocessing did not run
and there is nothing to display.
```

Key differences from original:
1. Echo instruction comes FIRST (primacy effect)
2. No `**FAIL-FAST:**` bold label
3. No "FAILED" or "STOP" keywords
4. No script path
5. Explains WHY (Anthropic docs: "add context/motivation to improve performance")
6. Uses positive framing: "content is ready — just echo it"
7. States the negative case as neutral fact: "there is nothing to display"

#### Finding 5: Structural techniques partially rescue the original FAIL-FAST
Tested with original FAIL-FAST present (Q3, 10 trials each):
- Original FAIL-FAST: **20%**
- XML priority tags wrapping echo instruction: **70%** (+50pp)
- Positive framing (no FAIL-FAST keyword): **80%** (+60pp)
- FAIL-FAST with WHY explanation: **70%** (+50pp)
- Positive + XML combo: **60%** (diminishing returns)

### Root Cause Mechanism
The FAIL-FAST block introduces a conditional evaluation ("If you do NOT see X above") that haiku interprets as a
CHECK to perform before acting. After tool-use priming turns, haiku's attention is split between:
1. Summarizing prior tool results (strong pattern from priming)
2. Evaluating the conditional (triggered by "If you do NOT see...")
3. Following the echo instruction

Haiku resolves this three-way conflict by defaulting to the strongest pattern (summarizing), abandoning both the
conditional check and the echo instruction. The words "FAILED" and "STOP" amplify this by priming error/halt behavior.

Anthropic's docs confirm: "Tell Claude what to do instead of what not to do" and "Add context to improve performance...
providing context or motivation behind your instructions helps Claude better understand your goals."

## Risk Assessment
- **Risk Level:** LOW
- **Regression Risk:** If preprocessing actually fails, the content won't be present and the agent will naturally
  have nothing to echo. The explanatory guard ("If the marker is missing...there is nothing to display") covers
  this case without using halt-inducing language.
- **Mitigation:** Verify skills still load and display correctly after changes

## Files to Modify
- `plugin/skills/status/first-use.md` - Replace FAIL-FAST with explanatory guard, remove description and legend
- `plugin/skills/token-report/first-use.md` - Replace FAIL-FAST with explanatory guard, remove description
- `plugin/skills/help/first-use.md` - Replace FAIL-FAST with explanatory guard, remove description
- `plugin/skills/render-diff/first-use.md` - Replace FAIL-FAST with explanatory guard, remove description
- `plugin/skills/work/first-use.md` - Replace FAIL-FAST with explanatory guard
- `plugin/skills/init/first-use.md` - Remove FAIL-FAST block
- `plugin/skills/run-retrospective/first-use.md` - Remove FAIL-FAST block
- `plugin/skills/skill-builder/first-use.md` - Update template to use explanatory guard pattern
- `plugin/skills/delegate/first-use.md` - Replace FAIL-FAST terminology with descriptive alternatives
- `plugin/skills/recover-from-drift/first-use.md` - Replace FAIL-FAST label with "Error handling"
- `plugin/skills/shrink-doc/first-use.md` - Replace FAIL-FAST label with "Iteration required"
- `plugin/skills/render-output/first-use.md` - Update echo instruction wording

## Acceptance Criteria
- [ ] No `**FAIL-FAST:**` blocks remain in any skill files
- [ ] No "FAIL-FAST" terminology used as bold instruction labels in any skill
- [ ] All verbatim output skills use the explanatory guard pattern
- [ ] Description lines removed from verbatim output skills (degrade haiku 100% → 60%)
- [ ] `skill-builder/first-use.md` template recommends explanatory guard pattern
- [ ] All affected skills load correctly via load-skill.sh

## Execution Steps
1. **Step 1:** Replace FAIL-FAST blocks in all affected skill files with explanatory guard pattern:
   ```
   The content above was generated by a preprocessing hook. If the "[MARKER]" marker is present,
   the content is ready — just echo it. If the marker is missing, preprocessing did not run and
   there is nothing to display.
   ```
2. **Step 2:** Update skill-builder template to recommend explanatory guard instead of FAIL-FAST
3. **Step 3:** Update STATE.md to closed

## Success Criteria
- [ ] Zero `**FAIL-FAST:**` blocks in verbatim output skill files
- [ ] Haiku achieves ~100% echo success with explanatory guard (verified by empirical test)
